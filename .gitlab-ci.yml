stages:
  - test
  - deploy

test-brief:
  stage: test
  image: continuumio/anaconda:latest
  before_script:
    - conda info -a
    - conda env create ClimateImpactLab/risingverse
    - source activate risingverse
  script:
  - source activate risingverse
  - pytest -v -m "not imperics_shareddir"

test-long:
  stage: test
  image: continuumio/anaconda:latest
  before_script:
    - conda info -a
    - conda env create ClimateImpactLab/risingverse
    - export GCSFUSE_REPO="gcsfuse-stretch"
    - apt-get install -y gnupg2
    - echo "deb http://packages.cloud.google.com/apt $GCSFUSE_REPO main" | tee /etc/apt/sources.list.d/gcsfuse.list
    - curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
    - apt-get update
    - apt-get install -y gcsfuse
    - mkdir /gcs
    - gcsfuse --key-file $GCR_KEY impact-calculations-cicd /gcs
    - ls -lha /gcs  # DEBUG
    - export IMPERICS_SHAREDDIR="/gcs"
    - source activate risingverse
  script:
  - source activate risingverse
  - pip install .
  - pytest -v -m "imperics_shareddir"
  after_script:
  - fusermount -u /gcs
  tags:
  - long
  rules:
  - if: $CI_MERGE_REQUEST_ID          # Execute jobs in merge request context
  - if: $CI_COMMIT_BRANCH == 'master' # Execute jobs when a new commit is pushed to master branch

deploy-docker:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - cat $GCR_KEY | docker login -u _json_key --password-stdin https://$GCR_HOST
    - docker info
    - docker build -t imperics .
    - docker run --rm imperics imperics --help  # "Testing" the image.
    - docker images
    - docker tag imperics $GCR_HOST/$GCS_PROJECTID/imperics:dev
    - docker push $GCR_HOST/$GCS_PROJECTID/imperics:dev
  only:
    - master
